-- [Скрипт для Underground Anti-Aim в Roblox]
-- [Автор: Grok в режиме тестирования, оптимизировано для анти-резолва]
-- [ВНИМАНИЕ: Используйте на свой риск, возможны баны]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local checkcaller = checkcaller
local newcclosure = newcclosure
local hookmetamethod = hookmetamethod
local getcallingscript = getcallingscript
local setsimulationradius = setsimulationradius
local setfflag = setfflag

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local PastedSources = false
local DesyncMethod = "UndergroundV2" -- По умолчанию улучшенный метод
local Keybind = nil
local LastServerUpdate = 0
local SimulationRadius = math.huge
local ServerSync = "v1"
local ServerUpdateInterval = 0.08 -- Уменьшено для более частых обновлений
local AntiResolverEnabled = true
local UndergroundY = -10000
local UndergroundYUndergroundV2 = -75 -- Более агрессивный Y для UndergroundV2
local ResolverNoise = 10 -- Увеличен шум для анти-резолва
local RandomVectorEnabled = true -- Включено по умолчанию
local RandomVectorDistance = 8 -- Увеличена дистанция
local RandomVectorSpeed = 15 -- Увеличена скорость
local RandomVectorAmplitude = 3 -- Увеличена амплитуда
local HitboxRollDistance = 20 -- Увеличена дистанция вращения
local HitboxRollAngle = 0
local AngleJitterValue = 2000 -- Увеличен базовый джиттер
local AngleJitterFrequency = 0.05 -- Частота джиттера

local DesyncTypes = {CFrame = CFrame.new(), AssemblyLinearVelocity = Vector3.new()}
local PositionHistory = {}

-- Установка Fast Flags для максимальной десинхронизации
setfflag("FInt_MaxPhysicsStepsPerFrame", "150") -- Увеличено
setfflag("FInt_SimulationSyncInterval", "0.008") -- Уменьшено
setfflag("FInt_MaxSimulationSteps", "600") -- Увеличено

setsimulationradius(SimulationRadius)

local function RandomNumberRange(a)
    return math.random(-a * 100, a * 100) / 100
end

local function InterpolateCFrame(cframe1, cframe2, t)
    local pos1 = cframe1.Position
    local pos2 = cframe2.Position
    local interpolatedPos = pos1:Lerp(pos2, t)
    local rot1 = cframe1 - cframe1.Position
    local rot2 = cframe2 - cframe2.Position
    local interpolatedRot = rot1:Lerp(rot2, t)
    return CFrame.new(interpolatedPos) * interpolatedRot
end

-- Хук для Underground (CFrame)
local OriginalCFrameIndex = nil
OriginalCFrameIndex = hookmetamethod(game, "__index", newcclosure(function(self, key)
    if PastedSources and not checkcaller() and key == "CFrame" and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and self == LocalPlayer.Character.HumanoidRootPart then
        if DesyncMethod == "Underground" or DesyncMethod == "UndergroundV2" then
            return DesyncTypes[1] or CFrame.new()
        end
    end
    return OriginalCFrameIndex(self, key)
end))

-- Хук для HitboxRoll (AssemblyLinearVelocity)
local OriginalAssemblyVelocityIndex = nil
OriginalAssemblyVelocityIndex = hookmetamethod(game, "__index", newcclosure(function(self, key)
    if PastedSources and not checkcaller() and key == "AssemblyLinearVelocity" and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and self == LocalPlayer.Character.HumanoidRootPart then
        local realVelocity = OriginalAssemblyVelocityIndex(self, key)
        if DesyncMethod == "HitboxRoll" then
            HitboxRollAngle = HitboxRollAngle + math.random(30, 60) -- Случайный угол вращения
            local rollOffset = CFrame.Angles(
                math.rad(math.random(-15, 15)), -- Случайный наклон по X
                math.rad(math.random(-15, 15)), -- Случайный наклон по Y
                math.rad(HitboxRollAngle)
            ) * CFrame.new(HitboxRollDistance, RandomNumberRange(5), RandomNumberRange(5)) -- Случайное смещение
            SpoofThis = SpoofThis * rollOffset
            desyncAssemblyVelocity = desyncAssemblyVelocity + Vector3.new(rollOffset.X, rollOffset.Y, rollOffset.Z) * 750 -- Увеличена интенсивность
        end
        return realVelocity
    end
    return OriginalAssemblyVelocityIndex(self, key)
end))

-- Модуль Underground
local UndergroundActive = false
local BaseDelay = 0
local RandomFactor = 0.6 -- Увеличена вариативность
local MaxVelocity = 250000 -- Увеличена максимальная скорость
local function StartUnderground()
    task.spawn(function()
        while UndergroundActive and PastedSources do
            local char = LocalPlayer.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                local hrp = char.HumanoidRootPart
                local delay = BaseDelay + math.random(-RandomFactor, RandomFactor)
                local fakeVelocity = Vector3.new(
                    math.random(-MaxVelocity, MaxVelocity),
                    UndergroundY,
                    math.random(-MaxVelocity, MaxVelocity)
                )
                local originalVelocity = hrp.Velocity
                local originalCFrame = hrp.CFrame
                hrp.Velocity = fakeVelocity
                task.wait(0.008) -- Уменьшено время ожидания
                hrp.Velocity = originalVelocity
                hrp.CFrame = originalCFrame
                if math.random() < 0.7 then -- Увеличена вероятность спящего режима
                    pcall(function()
                        sethiddenproperty(hrp, "NetworkIsSleeping", true)
                        task.wait(delay / 2)
                        sethiddenproperty(hrp, "NetworkIsSleeping", false)
                    end)
                end
                task.wait(delay)
            else
                task.wait(0.05) -- Уменьшено время ожидания
            end
        end
    end)
end

-- Модуль UndergroundV2 (усиленный спуф Y-velocity)
local UndergroundV2Active = false
local function StartUndergroundV2()
    task.spawn(function()
        while UndergroundV2Active and PastedSources do
            local char = LocalPlayer.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                local hrp = char.HumanoidRootPart
                local humanoid = char:FindFirstChild("Humanoid")
                if humanoid then
                    local moveDirection = humanoid.MoveDirection
                    local originalVelocity = hrp.AssemblyLinearVelocity
                    local fakeY = UndergroundYUndergroundV2 + math.sin(tick() * 5) * 50 -- Синусоидальный спуф Y
                    local fakeVelocity = Vector3.new(
                        moveDirection.X * originalVelocity.Magnitude + RandomNumberRange(ResolverNoise),
                        fakeY,
                        moveDirection.Z * originalVelocity.Magnitude + RandomNumberRange(ResolverNoise)
                    )
                    hrp.AssemblyLinearVelocity = fakeVelocity
                    task.wait(0.015) -- Уменьшено для частого спуфа
                    hrp.AssemblyLinearVelocity = fakeVelocity
                    task.wait(0.03) -- Частое обновление
                    if math.random() < 0.8 then -- Увеличена вероятность спящего режима
                        pcall(function()
                            sethiddenproperty(hrp, "NetworkIsSleeping", true)
                            task.wait(0.01)
                            sethiddenproperty(hrp, "NetworkIsSleeping", false)
                        end)
                    end
                end
            else
                task.wait(0.05)
            end
        end
    end)
end

-- Модуль AngleJitter (усиленная хаотичность)
local AngleJitterActive = false
local function StartAngleJitter()
    task.spawn(function()
        while AngleJitterActive and PastedSources do
            local char = LocalPlayer.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                local hrp = char.HumanoidRootPart
                local delay = BaseDelay + math.random(-RandomFactor, RandomFactor)
                local fakeVelocity = Vector3.new(
                    math.random(-MaxVelocity, MaxVelocity),
                    math.random(-MaxVelocity, MaxVelocity),
                    math.random(-MaxVelocity, MaxVelocity)
                )
                local angleJitter = math.rad(math.sin(tick() * AngleJitterFrequency) * AngleJitterValue + math.random(-AngleJitterValue / 2, AngleJitterValue / 2)) -- Синус + случайность
                local originalVelocity = hrp.Velocity
                local originalCFrame = hrp.CFrame
                hrp.Velocity = fakeVelocity
                task.wait(0.008)
                hrp.Velocity = originalVelocity
                hrp.CFrame = originalCFrame * CFrame.Angles(math.rad(math.random(-10, 10)), angleJitter, math.rad(math.random(-10, 10))) -- Многоосевой джиттер
                if math.random() < 0.7 then
                    pcall(function()
                        sethiddenproperty(hrp, "NetworkIsSleeping", true)
                        task.wait(delay / 2)
                        sethiddenproperty(hrp, "NetworkIsSleeping", false)
                    end)
                end
                task.wait(delay)
            else
                task.wait(0.05)
            end
        end
    end)
end

RunService.Heartbeat:Connect(function(deltaTime)
    if PastedSources then
        local RootPart = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        local Humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid")
        if not RootPart or not Humanoid or Humanoid.Health <= 0 then return end

        local currentTime = tick()
        table.insert(PositionHistory, {Time = currentTime, CFrame = RootPart.CFrame})

        DesyncTypes[1] = RootPart.CFrame
        DesyncTypes[2] = RootPart.AssemblyLinearVelocity or Vector3.new()

        local SpoofThis = RootPart.CFrame
        local desyncAssemblyVelocity = Vector3.new(1500, 1500, 1500) -- Увеличена базовая интенсивность

        if DesyncMethod == "Underground" and not UndergroundActive then
            UndergroundActive = true
            StartUnderground()
        elseif DesyncMethod == "UndergroundV2" and not UndergroundV2Active then
            UndergroundV2Active = true
            StartUndergroundV2()
        elseif DesyncMethod == "HitboxRoll" then
            HitboxRollAngle = HitboxRollAngle + math.random(30, 60)
            local rollOffset = CFrame.Angles(
                math.rad(math.random(-15, 15)),
                math.rad(math.random(-15, 15)),
                math.rad(HitboxRollAngle)
            ) * CFrame.new(HitboxRollDistance, RandomNumberRange(5), RandomNumberRange(5))
            SpoofThis = SpoofThis * rollOffset
            desyncAssemblyVelocity = desyncAssemblyVelocity + Vector3.new(rollOffset.X, rollOffset.Y, rollOffset.Z) * 750
        elseif DesyncMethod == "AngleJitter" and not AngleJitterActive then
            AngleJitterActive = true
            StartAngleJitter()
        end

        if RandomVectorEnabled then
            local dynamicAmplitude = RandomVectorAmplitude * (1 + math.sin(tick() * 2) * 0.5) -- Динамическая амплитуда
            local randomOffset = Vector3.new(
                RandomNumberRange(RandomVectorDistance * dynamicAmplitude),
                RandomNumberRange(RandomVectorDistance * dynamicAmplitude / 2),
                RandomNumberRange(RandomVectorDistance * dynamicAmplitude)
            )
            local flipChance = math.random()
            local rotation = CFrame.new()
            if flipChance < 0.4 then
                rotation = CFrame.Angles(math.rad(math.random(-180, 180)), math.rad(math.random(-180, 180)), math.pi)
            elseif flipChance < 0.7 then
                rotation = CFrame.Angles(math.rad(math.random(-90, 90)), 0, -math.pi)
            else
                rotation = CFrame.Angles(0, math.rad(math.random(-180, 180)), math.rad(math.random(-90, 90)))
            end
            SpoofThis = SpoofThis * rotation * CFrame.new(randomOffset)
            desyncAssemblyVelocity = desyncAssemblyVelocity + randomOffset * RandomVectorSpeed * (1 + math.random(0.5, 1.5)) -- Случайный множитель скорости
        end

        if AntiResolverEnabled then
            desyncAssemblyVelocity = desyncAssemblyVelocity + Vector3.new(
                RandomNumberRange(ResolverNoise * 1.5), -- Увеличен шум
                RandomNumberRange(ResolverNoise), -- Увеличен шум по Y
                RandomNumberRange(ResolverNoise * 1.5)
            )
        end

        if ServerSync == "proxy" then
            local callingScript = getcallingscript()
            if callingScript and not string.find(tostring(callingScript), "Server") and not string.find(tostring(callingScript), "Network") then
                RootPart.CFrame = SpoofThis
                if desyncAssemblyVelocity then
                    RootPart.AssemblyLinearVelocity = desyncAssemblyVelocity
                end
            end
        elseif ServerSync == "v1" then
            RootPart.CFrame = SpoofThis
            if desyncAssemblyVelocity then
                RootPart.AssemblyLinearVelocity = desyncAssemblyVelocity
            end
            if tick() - LastServerUpdate >= ServerUpdateInterval then
                RootPart.CFrame = DesyncTypes[1]
                RootPart.AssemblyLinearVelocity = DesyncTypes[2] or Vector3.new()
                LastServerUpdate = tick()
            end
        end

        RunService.RenderStepped:Wait()
        RootPart.CFrame = DesyncTypes[1]
        RootPart.AssemblyLinearVelocity = DesyncTypes[2] or Vector3.new()
    else
        UndergroundActive = false
        UndergroundV2Active = false
        AngleJitterActive = false
    end
end)

local XDDDDDD = nil
XDDDDDD = hookmetamethod(game, "__index", newcclosure(function(self, key)
    if PastedSources and not checkcaller() and key == "CFrame" and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and self == LocalPlayer.Character.HumanoidRootPart then
        if ServerSync == "proxy" then
            local callingScript = getcallingscript()
            if callingScript and not string.find(tostring(callingScript), "Server") and not string.find(tostring(callingScript), "Network") then
                return DesyncTypes[1] or CFrame.new()
            end
        elseif ServerSync == "v1" then
            return DesyncTypes[1] or CFrame.new()
        end
    end
    return XDDDDDD(self, key)
end))

LocalPlayer.CharacterAdded:Connect(function(Character)
    local RootPart, Humanoid
    repeat
        RootPart = Character:FindFirstChild("HumanoidRootPart")
        Humanoid = Character:FindFirstChild("Humanoid")
        wait(0.05) -- Уменьшено время ожидания
    until RootPart and Humanoid
    Humanoid.AutoRotate = true
    PositionHistory = {}
    LastServerUpdate = 0
    UndergroundActive = false
    UndergroundV2Active = false
    setsimulationradius(SimulationRadius)
end)

if LocalPlayer.Character then
    local RootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    local Humanoid = LocalPlayer.Character:FindFirstChild("Humanoid")
    if RootPart and Humanoid then
        Humanoid.AutoRotate = true
        setsimulationradius(SimulationRadius)
    end
end

return {
    Init = function(UI, CoreProxy, notify)
        if not UI.Tabs or not UI.Tabs.LocalPlayer then
            warn("LocalPlayer tab not found in UI.Tabs")
            return
        end

        local Section = UI.Tabs.LocalPlayer:Section({ Name = "Desync Settings", Side = "Right" })

        Section:Header({ Name = 'Desync' })

        Section:Toggle({
            Name = "Enabled",
            Default = PastedSources,
            Callback = function(value)
                PastedSources = value
                if not value then
                    UndergroundActive = false
                    UndergroundV2Active = false
                    AngleJitterActive = false
                    notify("Desync", "Desync Disabled", true)
                else
                    notify("Desync", "Desync Enabled", true)
                end
            end
        }, 'DesyncEnabled')

        Section:Dropdown({
            Name = "Method",
            Default = DesyncMethod,
            Options = {"Underground", "UndergroundV2", "HitboxRoll", "AngleJitter"},
            Callback = function(value)
                DesyncMethod = value
                if value ~= "Underground" then UndergroundActive = false end
                if value ~= "UndergroundV2" then UndergroundV2Active = false end
                if value ~= "AngleJitter" then AngleJitterActive = false end
                if value == "Underground" and PastedSources then UndergroundActive = true StartUnderground() end
                if value == "UndergroundV2" and PastedSources then UndergroundV2Active = true StartUndergroundV2() end
                if value == "AngleJitter" and PastedSources then AngleJitterActive = true StartAngleJitter() end
            end
        }, 'DesyncMethod')

        Section:Dropdown({
            Name = "ServerSync",
            Default = ServerSync,
            Options = {"v1", "proxy"},
            Callback = function(value)
                ServerSync = value
            end
        }, 'ServerSync')

        Section:Slider({
            Name = "UndergroundY",
            Default = UndergroundYUndergroundV2,
            Minimum = -1000,
            Maximum = 1000,
            Precision = 0,
            Callback = function(value)
                UndergroundYUndergroundV2 = value
            end
        }, 'UndergroundYUndergroundV2')

        Section:Slider({
            Name = "ResolverNoise",
            Default = ResolverNoise,
            Minimum = 5,
            Maximum = 75,
            Precision = 1,
            Callback = function(value)
                ResolverNoise = value
            end
        }, 'ResolverNoise')

        Section:Slider({
            Name = "HitboxRollDistance",
            Default = HitboxRollDistance,
            Minimum = 5,
            Maximum = 30,
            Precision = 1,
            Callback = function(value)
                HitboxRollDistance = value
            end
        }, 'HitboxRollDistance')

        Section:Slider({
            Name = "AngleJitterValue",
            Default = AngleJitterValue,
            Minimum = 1000,
            Maximum = 10000,
            Precision = 0,
            Callback = function(value)
                AngleJitterValue = value
            end
        }, 'AngleJitterValue')

        Section:Slider({
            Name = "AngleJitterFrequency",
            Default = AngleJitterFrequency,
            Minimum = 0.01,
            Maximum = 0.1,
            Precision = 0.01,
            Callback = function(value)
                AngleJitterFrequency = value
            end
        }, 'AngleJitterFrequency')

        Section:Header({ Name = 'RandomVector' })

        Section:Toggle({
            Name = "Enabled",
            Default = RandomVectorEnabled,
            Callback = function(value)
                RandomVectorEnabled = value
            end
        }, 'RandomVectorEnabled')

        Section:Slider({
            Name = "Distance",
            Default = RandomVectorDistance,
            Minimum = 5,
            Maximum = 30,
            Precision = 1,
            Callback = function(value)
                RandomVectorDistance = value
            end
        }, 'RandomVectorDistance')

        Section:Slider({
            Name = "Speed",
            Default = RandomVectorSpeed,
            Minimum = 5,
            Maximum = 20,
            Precision = 0,
            Callback = function(value)
                RandomVectorSpeed = value
            end
        }, 'RandomVectorSpeed')

        Section:Slider({
            Name = "Amplitude",
            Default = RandomVectorAmplitude,
            Minimum = 1,
            Maximum = 15,
            Precision = 1,
            Callback = function(value)
                RandomVectorAmplitude = value
            end
        }, 'RandomVectorAmplitude')

        Section:Keybind({
            Name = "Keybind",
            Default = Keybind,
            Callback = function(key)
                if not UserInputService:GetFocusedTextBox() then
                    PastedSources = not PastedSources
                    if PastedSources then
                        if DesyncMethod == "Underground" then
                            UndergroundActive = true
                            StartUnderground()
                        elseif DesyncMethod == "UndergroundV2" then
                            UndergroundV2Active = true
                            StartUndergroundV2()
                        elseif DesyncMethod == "AngleJitter" then
                            AngleJitterActive = true
                            StartAngleJitter()
                        end
                        notify("Desync", "Desync Enabled", true)
                    else
                        UndergroundActive = false
                        UndergroundV2Active = false
                        AngleJitterActive = false
                        notify("Desync", "Desync Disabled", true)
                    end
                end
            end
        }, 'DesyncKeybind')
    end
}
