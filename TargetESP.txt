local TargetESP = {}

function TargetESP.Init(UI, Core, notify)
    local Players = Core.Services.Players
    local RunService = Core.Services.RunService
    local Workspace = Core.Services.Workspace
    local camera = Workspace.CurrentCamera

    local LocalPlayer = Core.PlayerData.LocalPlayer
    local localCharacter = LocalPlayer.Character

    local State = {
        TargetESP = {
            TargetESPActive = { Value = false, Default = false },
            TargetESPMethod = { Value = "All", Default = "All", Options = {"All", "KillAura", "AutoDodge"} },
            TargetESPRadius = { Value = 1.7, Default = 1.7 },
            TargetESPParts = { Value = 30, Default = 30 },
            TargetESPGradientSpeed = { Value = 4, Default = 4 },
            TargetESPGradient = { Value = true, Default = true },
            TargetESPColor = { Value = Color3.fromRGB(0, 0, 255), Default = Color3.fromRGB(0, 0, 255) },
            TargetESPYOffset = { Value = 0, Default = 0 },
            AnimateCircle = { Value = "None", Default = "None", Options = {"None", "Jello"} }
        }
    }

    local targetESPQuads = {}
    local targetESPBlurQuads = {}
    local animationProgress = 0
    local animationDirection = 1
    local lastTarget = nil

    local function destroyParts(parts)
        for _, part in ipairs(parts) do
            if part and part.Destroy then
                part:Destroy()
            end
        end
        table.clear(parts)
    end

    local function interpolateColor(color1, color2, factor)
        return Color3.new(
            color1.R + (color2.R - color1.R) * factor,
            color1.G + (color2.G - color1.G) * factor,
            color1.B + (color2.B - color1.B) * factor
        )
    end

    local function getTargetRootPart()
        local method = State.TargetESP.TargetESPMethod.Value
        local targetName = nil

        if method == "All" then
            targetName = Core.BulwarkTarget.CurrentTarget
        elseif method == "KillAura" then
            targetName = Core.BulwarkTarget.KillAuraTarget
        elseif method == "AutoDodge" then
            targetName = Core.BulwarkTarget.AutoDodgeTarget
        end

        if targetName and Players:FindFirstChild(targetName) then
            local targetPlayer = Players:FindFirstChild(targetName)
            return targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart")
        end
        return nil
    end

    local function createTargetESP()
        local rootPart = getTargetRootPart()
        if not rootPart then return end

        destroyParts(targetESPQuads)
        destroyParts(targetESPBlurQuads)

        local partsCount = State.TargetESP.TargetESPParts.Value
        for i = 1, partsCount do
            local quad = Drawing.new("Quad")
            quad.Visible = false
            quad.Thickness = 2 -- Увеличена толщина для более плавного вида
            quad.Filled = false
            quad.Color = State.TargetESP.TargetESPGradient.Value and
                interpolateColor(Core.GradientColors.Color1.Value, Core.GradientColors.Color2.Value, i / partsCount) or
                State.TargetESP.TargetESPColor.Value
            table.insert(targetESPQuads, quad)

            if State.TargetESP.AnimateCircle.Value == "Jello" then
                local blurQuad = Drawing.new("Quad")
                blurQuad.Visible = false
                blurQuad.Thickness = 2
                blurQuad.Filled = true
                blurQuad.Color = quad.Color
                blurQuad.Transparency = 0.3
                table.insert(targetESPBlurQuads, blurQuad)
            end
        end
    end

    local function updateTargetESP()
        if not State.TargetESP.TargetESPActive.Value then
            destroyParts(targetESPQuads)
            destroyParts(targetESPBlurQuads)
            return
        end

        local rootPart = getTargetRootPart()
        if not rootPart then
            destroyParts(targetESPQuads)
            destroyParts(targetESPBlurQuads)
            lastTarget = nil
            return
        end

        local currentTargetName
        if State.TargetESP.TargetESPMethod.Value == "All" then
            currentTargetName = Core.BulwarkTarget.CurrentTarget
        elseif State.TargetESP.TargetESPMethod.Value == "KillAura" then
            currentTargetName = Core.BulwarkTarget.KillAuraTarget
        elseif State.TargetESP.TargetESPMethod.Value == "AutoDodge" then
            currentTargetName = Core.BulwarkTarget.AutoDodgeTarget
        end

        if currentTargetName ~= lastTarget then
            lastTarget = currentTargetName
            createTargetESP()
        end

        local t = tick()
        local yOffset = State.TargetESP.AnimateCircle.Value == "Jello" and (math.sin(t * 2) * 0.5) or
            State.TargetESP.TargetESPYOffset.Value

        local center = Vector3.new(rootPart.Position.X, rootPart.Position.Y + yOffset, rootPart.Position.Z)
        local screenCenter, onScreenCenter = camera:WorldToViewportPoint(center)
        if not (onScreenCenter and screenCenter.Z > 0) then
            for _, quad in ipairs(targetESPQuads) do
                quad.Visible = false
            end
            for _, blurQuad in ipairs(targetESPBlurQuads) do
                blurQuad.Visible = false
            end
            return
        end

        local espRadius = State.TargetESP.TargetESPRadius.Value
        local partsCount = #targetESPQuads
        for i, quad in ipairs(targetESPQuads) do
            local angle1 = ((i - 1) / partsCount) * 2 * math.pi
            local angle2 = (i / partsCount) * 2 * math.pi

            -- Улучшение для более плавных линий
            local depthOffset = State.TargetESP.AnimateCircle.Value == "Jello" and (math.cos(t + (i / partsCount) * 2 * math.pi) * 0.15) or 0
            local point1 = center + Vector3.new(math.cos(angle1) * espRadius, depthOffset, math.sin(angle1) * espRadius)
            local point2 = center + Vector3.new(math.cos(angle2) * espRadius, depthOffset, math.sin(angle2) * espRadius)
            local point3 = center + Vector3.new(math.cos(angle1) * espRadius * 0.95, depthOffset, math.sin(angle1) * espRadius * 0.95)
            local point4 = center + Vector3.new(math.cos(angle2) * espRadius * 0.95, depthOffset, math.sin(angle2) * espRadius * 0.95)

            local screenPoint1, onScreen1 = camera:WorldToViewportPoint(point1)
            local screenPoint2, onScreen2 = camera:WorldToViewportPoint(point2)
            local screenPoint3, onScreen3 = camera:WorldToViewportPoint(point3)
            local screenPoint4, onScreen4 = camera:WorldToViewportPoint(point4)

            if onScreen1 and onScreen2 and onScreen3 and onScreen4 and screenPoint1.Z > 0 and screenPoint2.Z > 0 and screenPoint3.Z > 0 and screenPoint4.Z > 0 then
                quad.PointA = Vector2.new(screenPoint3.X, screenPoint3.Y)
                quad.PointB = Vector2.new(screenPoint4.X, screenPoint4.Y)
                quad.PointC = Vector2.new(screenPoint2.X, screenPoint2.Y)
                quad.PointD = Vector2.new(screenPoint1.X, screenPoint1.Y)
                quad.Visible = true
                if State.TargetESP.TargetESPGradient.Value then
                    local factor = (math.sin(t * State.TargetESP.TargetESPGradientSpeed.Value + (i / partsCount) * 2 * math.pi) + 1) / 2
                    quad.Color = interpolateColor(Core.GradientColors.Color1.Value, Core.GradientColors.Color2.Value, factor)
                else
                    quad.Color = State.TargetESP.TargetESPColor.Value
                end

                if State.TargetESP.AnimateCircle.Value == "Jello" and targetESPBlurQuads[i] then
                    local blurQuad = targetESPBlurQuads[i]
                    local blurOffset = 0.1
                    local blurCenter = Vector3.new(rootPart.Position.X, rootPart.Position.Y + yOffset - blurOffset, rootPart.Position.Z)
                    local blurPoint1 = blurCenter + Vector3.new(math.cos(angle1) * espRadius, depthOffset, math.sin(angle1) * espRadius)
                    local blurPoint2 = blurCenter + Vector3.new(math.cos(angle2) * espRadius, depthOffset, math.sin(angle2) * espRadius)
                    local blurPoint3 = blurCenter + Vector3.new(math.cos(angle1) * espRadius * 0.95, depthOffset, math.sin(angle1) * espRadius * 0.95)
                    local blurPoint4 = blurCenter + Vector3.new(math.cos(angle2) * espRadius * 0.95, depthOffset, math.sin(angle2) * espRadius * 0.95)

                    local screenBlurPoint1, onScreenBlur1 = camera:WorldToViewportPoint(blurPoint1)
                    local screenBlurPoint2, onScreenBlur2 = camera:WorldToViewportPoint(blurPoint2)
                    local screenBlurPoint3, onScreenBlur3 = camera:WorldToViewportPoint(blurPoint3)
                    local screenBlurPoint4, onScreenBlur4 = camera:WorldToViewportPoint(blurPoint4)

                    if onScreenBlur1 and onScreenBlur2 and onScreenBlur3 and onScreenBlur4 and screenBlurPoint1.Z > 0 and screenBlurPoint2.Z > 0 and screenBlurPoint3.Z > 0 and screenBlurPoint4.Z > 0 then
                        blurQuad.PointA = Vector2.new(screenBlurPoint3.X, screenBlurPoint3.Y)
                        blurQuad.PointB = Vector2.new(screenBlurPoint4.X, screenBlurPoint4.Y)
                        blurQuad.PointC = Vector2.new(screenBlurPoint2.X, screenBlurPoint2.Y)
                        blurQuad.PointD = Vector2.new(screenBlurPoint1.X, screenBlurPoint1.Y)
                        blurQuad.Visible = true
                        blurQuad.Color = quad.Color
                    else
                        blurQuad.Visible = false
                    end
                end
            else
                quad.Visible = false
                if targetESPBlurQuads[i] then
                    targetESPBlurQuads[i].Visible = false
                end
            end
        end
    end

    local function toggleTargetESP(value)
        State.TargetESP.TargetESPActive.Value = value
        if value then
            createTargetESP()
            notify("TargetESP", "Target ESP Enabled", true)
        else
            destroyParts(targetESPQuads)
            destroyParts(targetESPBlurQuads)
            lastTarget = nil
            notify("TargetESP", "Target ESP Disabled", true)
        end
    end

    local connection
    connection = RunService.RenderStepped:Connect(function()
        if localCharacter and State.TargetESP.TargetESPActive.Value then
            updateTargetESP()
        else
            destroyParts(targetESPQuads)
            destroyParts(targetESPBlurQuads)
            lastTarget = nil
        end
    end)

    LocalPlayer.CharacterAdded:Connect(function(character)
        localCharacter = character
    end)

    if UI.Tabs and UI.Tabs.Visuals then
        local targetESPSection = UI.Sections.TargetESP or UI.Tabs.Visuals:Section({ Name = "TargetESP", Side = "Right" })
        UI.Sections.TargetESP = targetESPSection
        targetESPSection:Header({ Name = "Target ESP" })
        targetESPSection:SubLabel({ Text = "Displays a circle effect above the target player" })
        targetESPSection:Toggle({
            Name = "Target ESP Enabled",
            Default = State.TargetESP.TargetESPActive.Default,
            Callback = function(value)
                toggleTargetESP(value)
            end,
            'TargetESPEnabled'
        })
        targetESPSection:Dropdown({
            Name = "Target ESP Method",
            Default = State.TargetESP.TargetESPMethod.Default,
            Options = State.TargetESP.TargetESPMethod.Options,
            Callback = function(value)
                State.TargetESP.TargetESPMethod.Value = value
                lastTarget = nil -- Сбрасываем для пересоздания
                if State.TargetESP.TargetESPActive.Value then
                    createTargetESP()
                end
                notify("TargetESP", "Target ESP Method set to: " .. value, false)
            end,
            'TargetESPMethod'
        })
        targetESPSection:Slider({
            Name = "Target ESP Radius",
            Minimum = 1.0,
            Maximum = 3.0,
            Default = State.TargetESP.TargetESPRadius.Default,
            Precision = 1,
            Callback = function(value)
                State.TargetESP.TargetESPRadius.Value = value
                if State.TargetESP.TargetESPActive.Value then
                    createTargetESP()
                end
                notify("TargetESP", "Target ESP Radius set to: " .. value, false)
            end,
            'TargetESPRadius'
        })
        targetESPSection:Slider({
            Name = "Target ESP Parts",
            Minimum = 20,
            Maximum = 100,
            Default = State.TargetESP.TargetESPParts.Default,
            Precision = 0,
            Callback = function(value)
                State.TargetESP.TargetESPParts.Value = value
                if State.TargetESP.TargetESPActive.Value then
                    createTargetESP()
                end
                notify("TargetESP", "Target ESP Parts set to: " .. value, false)
            end,
            'TargetESPParts'
        })
        targetESPSection:Slider({
            Name = "Gradient Speed",
            Minimum = 1,
            Maximum = 10,
            Default = State.TargetESP.TargetESPGradientSpeed.Default,
            Precision = 1,
            Callback = function(value)
                State.TargetESP.TargetESPGradientSpeed.Value = value
                notify("TargetESP", "Target ESP Gradient Speed set to: " .. value, false)
            end,
            'TargetESPGradientSpeed'
        })
        targetESPSection:Toggle({
            Name = "Gradient",
            Default = State.TargetESP.TargetESPGradient.Default,
            Callback = function(value)
                State.TargetESP.TargetESPGradient.Value = value
                if State.TargetESP.TargetESPActive.Value then
                    createTargetESP()
                end
                notify("TargetESP", "Target ESP Gradient: " .. (value and "Enabled" or "Disabled"), true)
            end,
            'TargetESPGradient'
        })
        targetESPSection:Colorpicker({
            Name = "Color",
            Default = State.TargetESP.TargetESPColor.Default,
            Callback = function(value)
                State.TargetESP.TargetESPColor.Value = value
                if State.TargetESP.TargetESPActive.Value and not State.TargetESP.TargetESPGradient.Value then
                    createTargetESP()
                end
                notify("TargetESP", "Target ESP Color updated", false)
            end,
            'TargetESPColor'
        })
        targetESPSection:Slider({
            Name = "Y Offset",
            Minimum = -5,
            Maximum = 5,
            Default = State.TargetESP.TargetESPYOffset.Default,
            Precision = 2,
            Callback = function(value)
                if State.TargetESP.AnimateCircle.Value ~= "Jello" then
                    State.TargetESP.TargetESPYOffset.Value = value
                    if State.TargetESP.TargetESPActive.Value then
                        createTargetESP()
                    end
                    notify("TargetESP", "Target ESP Y Offset set to: " .. value, false)
                end
            end,
            'TargetESPYOffset'
        })
        targetESPSection:Dropdown({
            Name = "Animate Circle",
            Default = State.TargetESP.AnimateCircle.Default,
            Options = State.TargetESP.AnimateCircle.Options,
            Callback = function(value)
                State.TargetESP.AnimateCircle.Value = value
                if State.TargetESP.TargetESPActive.Value then
                    createTargetESP()
                end
                notify("TargetESP", "Animate Circle set to: " .. value, false)
            end,
            'AnimateCircle'
        })
    end

    function TargetESP:Destroy()
        destroyParts(targetESPQuads)
        destroyParts(targetESPBlurQuads)
        if connection then
            connection:Disconnect()
        end
    end

    return TargetESP
end

return TargetESP
