local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local Core = nil
local UI = nil
local notify = nil

-- Конфигурация TargetESP
local Settings = {
    Enabled = false, -- Для трейсера
    Tracer2DOrigin = "From Bottom", -- "From Top", "From Bottom", "From Player"
    PlayerColor = Color3.fromRGB(255, 0, 0), -- Цвет трейсера и кругов
    TracerThickness = 2,
    TracerTransparency = 0.7,
    YOffset = 0, -- Смещение начальной точки по Y
    EndYOffset = 0, -- Смещение конечной точки по Y
    CircleDiameter = 5, -- Диаметр кругов
    CircleTransparency = 0.7, -- Прозрачность обводки кругов
    CircleFilled = true, -- Заполнение кругов
    FilledTransparency = 0.7, -- Прозрачность заливки кругов
    CirclesEnabled = true, -- Включение/выключение кругов
    MidCircle = false -- Включение дополнительных кругов диаметром 5
}

-- 2D трейсер (Drawing)
local tracer2D = Drawing.new("Line")
tracer2D.Thickness = Settings.TracerThickness
tracer2D.Transparency = Settings.TracerTransparency
tracer2D.Visible = false

-- 2D круги (основные)
local startCircle2D = Drawing.new("Circle")
startCircle2D.Radius = Settings.CircleDiameter / 2
startCircle2D.Transparency = Settings.CircleFilled and Settings.FilledTransparency or Settings.CircleTransparency
startCircle2D.Color = Settings.PlayerColor
startCircle2D.Visible = false
startCircle2D.Filled = Settings.CircleFilled

local endCircle2D = Drawing.new("Circle")
endCircle2D.Radius = Settings.CircleDiameter / 2
endCircle2D.Transparency = Settings.CircleFilled and Settings.FilledTransparency or Settings.CircleTransparency
endCircle2D.Color = Settings.PlayerColor
endCircle2D.Visible = false
endCircle2D.Filled = Settings.CircleFilled

-- Дополнительные круги для Mid Circle
local startMidCircle = Drawing.new("Circle")
startMidCircle.Radius = 2.5 -- Диаметр 5
startMidCircle.Transparency = Settings.FilledTransparency
startMidCircle.Color = Settings.PlayerColor
startMidCircle.Visible = false
startMidCircle.Filled = true

local endMidCircle = Drawing.new("Circle")
endMidCircle.Radius = 2.5 -- Диаметр 5
endMidCircle.Transparency = Settings.FilledTransparency
endMidCircle.Color = Settings.PlayerColor
endMidCircle.Visible = false
endMidCircle.Filled = true

-- Получение позиции локального игрока
local function GetLocalPlayerPosition()
    local character = LocalPlayer.Character
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    return rootPart and (rootPart.Position + Vector3.new(0, Settings.YOffset, 0)) or Camera.CFrame.Position
end

-- Получение экранной позиции локального игрока
local function GetLocalPlayerScreenPosition()
    local character = LocalPlayer.Character
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    if rootPart then
        local screenPos, onScreen = Camera:WorldToViewportPoint(rootPart.Position + Vector3.new(0, Settings.YOffset, 0))
        return onScreen and Vector2.new(screenPos.X, screenPos.Y) or nil
    end
    return nil
end

-- Получение позиции цели
local function GetTargetPosition(targetName)
    local player = Players:FindFirstChild(targetName)
    if player and player.Character then
        local humanoidRoot = player.Character:FindFirstChild("HumanoidRootPart")
        return humanoidRoot and (humanoidRoot.Position + Vector3.new(0, Settings.EndYOffset, 0)) or nil
    end
    return nil
end

-- Вычисление радиуса круга с учетом расстояния
local function GetScaledRadius(position)
    local distance = (Camera.CFrame.Position - position).Magnitude
    local baseDistance = 100 -- Базовое расстояние для масштабирования
    return math.clamp(Settings.CircleDiameter / 2 * (baseDistance / math.max(distance, 1)), 1, Settings.CircleDiameter)
end

-- Обновление трейсера и кругов
local function UpdateTracer()
    if not Core or not Core.GunSilentTarget or not Core.GunSilentTarget.CurrentTarget then
        tracer2D.Visible = false
        startCircle2D.Visible = false
        endCircle2D.Visible = false
        startMidCircle.Visible = false
        endMidCircle.Visible = false
        return
    end

    local targetName = Core.GunSilentTarget.CurrentTarget
    local targetPosition = GetTargetPosition(targetName)

    if not targetPosition then
        tracer2D.Visible = false
        startCircle2D.Visible = false
        endCircle2D.Visible = false
        startMidCircle.Visible = false
        endMidCircle.Visible = false
        return
    end

    local localPosition = GetLocalPlayerPosition()
    local screenPos, onScreen = Camera:WorldToViewportPoint(targetPosition)

    -- Обновление трейсера
    if Settings.Enabled and onScreen then
        local fromPos
        if Settings.Tracer2DOrigin == "From Top" then
            fromPos = Vector2.new(Camera.ViewportSize.X / 2, 0)
        elseif Settings.Tracer2DOrigin == "From Bottom" then
            fromPos = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
        elseif Settings.Tracer2DOrigin == "From Player" then
            fromPos = GetLocalPlayerScreenPosition()
            if not fromPos then
                tracer2D.Visible = false
            else
                tracer2D.From = fromPos
                tracer2D.To = Vector2.new(screenPos.X, screenPos.Y)
                tracer2D.Color = Settings.PlayerColor
                tracer2D.Thickness = Settings.TracerThickness
                tracer2D.Transparency = Settings.TracerTransparency
                tracer2D.Visible = true
            end
        end
        if fromPos then
            tracer2D.From = fromPos
            tracer2D.To = Vector2.new(screenPos.X, screenPos.Y)
            tracer2D.Color = Settings.PlayerColor
            tracer2D.Thickness = Settings.TracerThickness
            tracer2D.Transparency = Settings.TracerTransparency
            tracer2D.Visible = true
        else
            tracer2D.Visible = false
        end
    else
        tracer2D.Visible = false
    end

    -- Обновление кругов (работают независимо от Settings.Enabled)
    if Settings.CirclesEnabled and onScreen then
        endCircle2D.Position = Vector2.new(screenPos.X, screenPos.Y)
        endCircle2D.Color = Settings.PlayerColor
        endCircle2D.Radius = GetScaledRadius(targetPosition)
        endCircle2D.Transparency = Settings.CircleFilled and Settings.FilledTransparency or Settings.CircleTransparency
        endCircle2D.Filled = Settings.CircleFilled
        endCircle2D.Visible = true
        if Settings.MidCircle then
            endMidCircle.Position = Vector2.new(screenPos.X, screenPos.Y)
            endMidCircle.Color = Settings.PlayerColor
            endMidCircle.Transparency = Settings.FilledTransparency
            endMidCircle.Visible = true
        else
            endMidCircle.Visible = false
        end
        if Settings.Tracer2DOrigin == "From Player" then
            local fromPos = GetLocalPlayerScreenPosition()
            if fromPos then
                startCircle2D.Position = fromPos
                startCircle2D.Color = Settings.PlayerColor
                startCircle2D.Radius = GetScaledRadius(localPosition)
                startCircle2D.Transparency = Settings.CircleFilled and Settings.FilledTransparency or Settings.CircleTransparency
                startCircle2D.Filled = Settings.CircleFilled
                startCircle2D.Visible = true
                if Settings.MidCircle then
                    startMidCircle.Position = fromPos
                    startMidCircle.Color = Settings.PlayerColor
                    startMidCircle.Transparency = Settings.FilledTransparency
                    startMidCircle.Visible = true
                else
                    startMidCircle.Visible = false
                end
            else
                startCircle2D.Visible = false
                startMidCircle.Visible = false
            end
        else
            startCircle2D.Visible = false
            startMidCircle.Visible = false
        end
    else
        startCircle2D.Visible = false
        endCircle2D.Visible = false
        startMidCircle.Visible = false
        endMidCircle.Visible = false
    end
end

-- Инициализация модуля
function Init(ui, core, notification)
    UI = ui
    Core = core
    notify = notification

    if not UI or not Core or not notify then
        return
    end

    -- Создание секций в UI.Tabs.Visuals (вкладка уже существует)
    UI.Sections = UI.Sections or {}
    UI.Sections.TargetTracer = UI.Tabs.Visuals:Section({ Name = "Target Tracer", Side = "Right" })
    UI.Sections.Circles = UI.Tabs.Visuals:Section({ Name = "Circles", Side = "Right" })

    -- UI элементы для Target Tracer
    UI.Sections.TargetTracer:Header({ Name = "Target Tracer" })

    UI.Sections.TargetTracer:Toggle({
        Name = "Enabled",
        Default = Settings.Enabled,
        Callback = function(value)
            Settings.Enabled = value
            tracer2D.Visible = value and Core.GunSilentTarget.CurrentTarget ~= nil
            notify("Target Tracer", "Toggled " .. (value and "ON" or "OFF"), false)
        end
    }, "TargetTracerEnabled")

    UI.Sections.TargetTracer:Colorpicker({
        Name = "Player Color",
        Default = Settings.PlayerColor,
        Callback = function(value)
            Settings.PlayerColor = value
            tracer2D.Color = value
            startCircle2D.Color = value
            endCircle2D.Color = value
            startMidCircle.Color = value
            endMidCircle.Color = value
            notify("Target Tracer", "Player Color updated", false)
        end
    }, "TargetTracerPlayerColor")

    UI.Sections.TargetTracer:Dropdown({
        Name = "2D Tracer Origin",
        Options = {"From Top", "From Bottom", "From Player"},
        Default = Settings.Tracer2DOrigin,
        MultiSelection = false,
        Callback = function(value)
            Settings.Tracer2DOrigin = value
            startCircle2D.Visible = Settings.CirclesEnabled and value == "From Player" and Core.GunSilentTarget.CurrentTarget ~= nil
            startMidCircle.Visible = Settings.CirclesEnabled and Settings.MidCircle and value == "From Player" and Core.GunSilentTarget.CurrentTarget ~= nil
            notify("Target Tracer", "2D Tracer Origin set to: " .. value, false)
        end
    }, "TargetTracer2DOrigin")

    UI.Sections.TargetTracer:Slider({
        Name = "Tracer Thickness",
        Minimum = 1,
        Maximum = 10,
        Default = Settings.TracerThickness,
        Precision = 0,
        Suffix = "px",
        Callback = function(value)
            Settings.TracerThickness = value
            tracer2D.Thickness = value
            notify("Target Tracer", "Tracer Thickness set to: " .. value .. "px", false)
        end
    }, "TargetTracerThickness")

    UI.Sections.TargetTracer:Slider({
        Name = "Tracer Transparency",
        Minimum = 0,
        Maximum = 1,
        Default = Settings.TracerTransparency,
        Precision = 2,
        Suffix = "",
        Callback = function(value)
            Settings.TracerTransparency = value
            tracer2D.Transparency = value
            notify("Target Tracer", "Tracer Transparency set to: " .. value, false)
        end
    }, "TargetTracerTransparency")

    UI.Sections.TargetTracer:Slider({
        Name = "Y Offset",
        Minimum = -3,
        Maximum = 3,
        Default = Settings.YOffset,
        Precision = 2,
        Suffix = "",
        Callback = function(value)
            Settings.YOffset = value
            notify("Target Tracer", "Y Offset set to: " .. value, false)
        end
    }, "TargetTracerYOffset")

    UI.Sections.TargetTracer:Slider({
        Name = "End Y Offset",
        Minimum = -3,
        Maximum = 3,
        Default = Settings.EndYOffset,
        Precision = 2,
        Suffix = "",
        Callback = function(value)
            Settings.EndYOffset = value
            notify("Target Tracer", "End Y Offset set to: " .. value, false)
        end
    }, "TargetTracerEndYOffset")

    -- UI элементы для Circles
    UI.Sections.Circles:Header({ Name = "Circles" })

    UI.Sections.Circles:Toggle({
        Name = "Circles Enabled",
        Default = Settings.CirclesEnabled,
        Callback = function(value)
            Settings.CirclesEnabled = value
            startCircle2D.Visible = value and Settings.Tracer2DOrigin == "From Player" and Core.GunSilentTarget.CurrentTarget ~= nil
            endCircle2D.Visible = value and Core.GunSilentTarget.CurrentTarget ~= nil
            startMidCircle.Visible = value and Settings.MidCircle and Settings.Tracer2DOrigin == "From Player" and Core.GunSilentTarget.CurrentTarget ~= nil
            endMidCircle.Visible = value and Settings.MidCircle and Core.GunSilentTarget.CurrentTarget ~= nil
            notify("Target Tracer", "Circles Enabled " .. (value and "ON" or "OFF"), false)
        end
    }, "TargetTracerCirclesEnabled")

    UI.Sections.Circles:Slider({
        Name = "Circle Diameter",
        Minimum = 2,
        Maximum = 20,
        Default = Settings.CircleDiameter,
        Precision = 0,
        Suffix = "px",
        Callback = function(value)
            Settings.CircleDiameter = value
            startCircle2D.Radius = value / 2
            endCircle2D.Radius = value / 2
            notify("Target Tracer", "Circle Diameter set to: " .. value .. "px", false)
        end
    }, "TargetTracerCircleDiameter")

    UI.Sections.Circles:Slider({
        Name = "Filled Transparency",
        Minimum = 0,
        Maximum = 1,
        Default = Settings.FilledTransparency,
        Precision = 2,
        Suffix = "",
        Callback = function(value)
            Settings.FilledTransparency = value
            startCircle2D.Transparency = Settings.CircleFilled and value or Settings.CircleTransparency
            endCircle2D.Transparency = Settings.CircleFilled and value or Settings.CircleTransparency
            startMidCircle.Transparency = value
            endMidCircle.Transparency = value
            notify("Target Tracer", "Filled Transparency set to: " .. value, false)
        end
    }, "TargetTracerFilledTransparency")

    UI.Sections.Circles:Toggle({
        Name = "Circle Filled",
        Default = Settings.CircleFilled,
        Callback = function(value)
            Settings.CircleFilled = value
            startCircle2D.Filled = value
            endCircle2D.Filled = value
            startCircle2D.Transparency = value and Settings.FilledTransparency or Settings.CircleTransparency
            endCircle2D.Transparency = value and Settings.FilledTransparency or Settings.CircleTransparency
            notify("Target Tracer", "Circle Filled " .. (value and "ON" or "OFF"), false)
        end
    }, "TargetTracerCircleFilled")

    UI.Sections.Circles:Toggle({
        Name = "Mid Circle",
        Default = Settings.MidCircle,
        Callback = function(value)
            Settings.MidCircle = value
            startMidCircle.Visible = value and Settings.CirclesEnabled and Settings.Tracer2DOrigin == "From Player" and Core.GunSilentTarget.CurrentTarget ~= nil
            endMidCircle.Visible = value and Settings.CirclesEnabled and Core.GunSilentTarget.CurrentTarget ~= nil
            notify("Target Tracer", "Mid Circle " .. (value and "ON" or "OFF"), false)
        end
    }, "TargetTracerMidCircle")

    -- Обновление трейсера каждый кадр
    RunService.RenderStepped:Connect(UpdateTracer)
end

-- Очистка при телепортации
game:GetService("Players").LocalPlayer.OnTeleport:Connect(function()
    tracer2D:Remove()
    startCircle2D:Remove()
    endCircle2D:Remove()
    startMidCircle:Remove()
    endMidCircle:Remove()
end)

return {
    Init = Init
}
